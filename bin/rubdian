#!/usr/bin/env ruby

require "rubdian"
require "rubdian/version"
require "logger"
require "rubdian/trollop"


# parse arguments
SUB_COMMANDS = ["setup", "collect", "upgrade", "database", "blacklist", "queue"]

gopts = Trollop::options do
  version = "rubdian #{Rubdian::VERSION} (c) 2013 CORPEX Internet GmbH"
  banner "rubdian #{Rubdian::VERSION} (c) 2013 CORPEX Internet GmbH"
  banner ""
  banner "Rubdian is a tool to automatically collect updates on debian based systems."
  banner ""
  if SUB_COMMANDS.count > 0
    banner "Subcommands:"

    SUB_COMMANDS.each do |sc|
      banner "\t#{sc}"
    end
    banner ""
    banner "See rubdian <subcommand> --help for more informations regarding any subcommand"
    banner "and some usage examples."
  end
  banner ""
  banner "Global options:"
  opt :config, "Use different configfile", :short => "-f", :default => '/etc/rubdian/rubdian.yml'
  opt :concurrent, "Number of concurrent threads", :short => "-c", :default => 1
  opt :list, "Use file as a server list.", :short => "-l", :default => '/etc/rubdian/server.list'
  opt :username, "Username to use for ssh connections.", :short => "-u", :default => ENV['USER']
  opt :debug, "Enable debug messages.", :short => "-d", :default => false
  stop_on SUB_COMMANDS
end

Rubdian.logger.level = Logger::ERROR
if gopts[:debug]
  Rubdian.logger.level = Logger::DEBUG
end
cmd = ARGV.shift

if ! SUB_COMMANDS.include? cmd
  puts "#{cmd} is no valid subcommand. See --help"
  exit 1
end

require "rubdian/command/#{cmd}"
_mod = eval("Rubdian::Command::#{cmd.capitalize}")
_mod.main(gopts)

